[nebula]
name = "prompt-caching"
description = "Build a project context snapshot system that generates a shared system prompt prefix for all agent invocations in a nebula run. By front-loading repo structure, conventions, and key interfaces into a stable prompt prefix, Anthropic's prompt caching gives a 90% discount on cached input tokens — turning N×M redundant context reads into one cached block."

[defaults]
type = "feature"
priority = 2
labels = ["quasar", "performance", "cost-optimization"]

[execution]
max_workers = 3
max_review_cycles = 5
max_budget_usd = 50.0

[context]
repo = "github.com/papapumpkin/quasar"
working_dir = "."
goals = [
    "Build a reusable project context scanner that works on any repo quasar runs against",
    "Generate a structured snapshot (repo tree, CLAUDE.md, key interfaces, architecture) for prompt prefixing",
    "Inject the snapshot into agent system prompts so all workers share the same cached prefix",
    "Achieve prompt cache hits across all agent invocations within a nebula run",
    "Make context generation fast enough to run at nebula-apply time without noticeable delay",
]
constraints = [
    "Follow existing Go conventions from CLAUDE.md",
    "The snapshot must be deterministic — same repo state produces same snapshot byte-for-byte",
    "Snapshot size must stay under ~8K tokens to keep the cache prefix reasonable",
    "Must work on any repo, not just quasar — no hardcoded paths or Go-specific assumptions",
    "Use stdlib only — no external dependencies for file scanning",
    "The context is prepended to system prompts, not user prompts (system prompt caching is more effective)",
    "Existing agent invocation behavior must not change when context is disabled/empty",
    "Context generation should be a single pass — no network calls or expensive analysis",
]
