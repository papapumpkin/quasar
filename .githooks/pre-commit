#!/usr/bin/env bash
set -euo pipefail

# Format staged Go files with goimports, re-stage, then lint.
# Chains to bd (beads) hook at the end.

STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM -- '*.go')

if [ -n "$STAGED_GO_FILES" ]; then
    # Auto-format and re-stage so lint sees the formatted version.
    if command -v goimports >/dev/null 2>&1; then
        echo "$STAGED_GO_FILES" | xargs goimports -local github.com/aaronsalm/quasar -w
    else
        echo "$STAGED_GO_FILES" | xargs gofmt -w
    fi
    echo "$STAGED_GO_FILES" | xargs git add

    # Lint the formatted code.
    if command -v golangci-lint >/dev/null 2>&1; then
        golangci-lint run ./...
    fi
fi

# Chain to beads hook.
if command -v bd >/dev/null 2>&1; then
    exec bd hook pre-commit "$@"
fi
